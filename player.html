<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>å¼¹å¹•BOSSæˆ˜ - ç©å®¶ç«¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #60a5fa 100%);
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            -webkit-user-select: none;
            user-select: none;
            position: relative;
        }

        @keyframes gradientShift {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        /* æ–°å¹´æ ‡é¢˜ */
        .new-year-title {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            text-align: center;
            color: #ffd700;
            text-shadow: 
                0 0 10px rgba(255, 215, 0, 0.8),
                0 0 20px rgba(255, 215, 0, 0.6),
                0 0 30px rgba(255, 215, 0, 0.4),
                2px 2px 4px rgba(0, 0, 0, 0.5);
            font-size: 28px;
            font-weight: bold;
            letter-spacing: 2px;
            white-space: nowrap;
            animation: titleGlow 2s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            0% {
                text-shadow: 
                    0 0 10px rgba(255, 215, 0, 0.8),
                    0 0 20px rgba(255, 215, 0, 0.6),
                    0 0 30px rgba(255, 215, 0, 0.4),
                    2px 2px 4px rgba(0, 0, 0, 0.5);
            }
            100% {
                text-shadow: 
                    0 0 15px rgba(255, 215, 0, 1),
                    0 0 30px rgba(255, 215, 0, 0.8),
                    0 0 45px rgba(255, 215, 0, 0.6),
                    2px 2px 4px rgba(0, 0, 0, 0.5);
            }
        }

        .player-container {
            width: 100%;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .player-setup {
            margin-bottom: 30px;
        }

        .setup-item {
            margin-bottom: 20px;
        }

        .setup-item label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        .avatar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .avatar-preview {
            width: 100px;
            height: 100px;
            border: 3px dashed #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #f5f5f5;
            cursor: pointer;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .avatar-placeholder {
            color: #999;
            font-size: 14px;
        }

        input[type="file"] {
            display: none;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .bullet-input-section {
            margin-top: 30px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .input-group input {
            flex: 1;
            font-size: 16px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            min-height: 44px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .connection-info {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 10px;
            font-size: 14px;
            color: #666;
        }

        @media (max-width: 768px) {
            .player-container {
                padding: 20px;
            }

            h1 {
                font-size: 20px;
            }
            
            /* æ–°å¹´æ ‡é¢˜ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .new-year-title {
                font-size: 18px;
                top: 10px;
                letter-spacing: 1px;
            }
        }
        
        @media (max-width: 480px) {
            .new-year-title {
                font-size: 14px;
                top: 5px;
                letter-spacing: 0.5px;
            }
        }
    </style>
</head>
<body>
    <div class="new-year-title">LarkGames - å¹´ä¼šæ´»åŠ¨</div>
    <div class="player-container">
        <h1>ğŸ® å¼¹å¹•BOSSæˆ˜ - ç©å®¶ç«¯</h1>
        
        <!-- ç©å®¶è®¾ç½® -->
        <div class="player-setup" id="playerSetup">
            <div class="setup-item">
                <label>ä¸Šä¼ å¤´åƒï¼š</label>
                <div class="avatar-section">
                    <div class="avatar-preview" id="avatarPreview">
                        <img id="avatarImg" src="" alt="å¤´åƒ">
                        <div class="avatar-placeholder">ç‚¹å‡»ä¸Šä¼ </div>
                    </div>
                    <input type="file" id="avatarInput" accept="image/*">
                    <button class="btn" id="uploadBtn">é€‰æ‹©å¤´åƒ</button>
                </div>
            </div>
            <div class="setup-item">
                <label>ç©å®¶åå­—ï¼š</label>
                <input type="text" id="playerName" placeholder="è¯·è¾“å…¥ä½ çš„åå­—" maxlength="20">
            </div>
            <button class="btn btn-primary" id="confirmSetup" disabled>ç¡®è®¤è®¾ç½®</button>
        </div>

        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="status disconnected" id="status">
            âš ï¸ æœªè¿æ¥æœåŠ¡å™¨
        </div>

        <!-- å¼¹å¹•è¾“å…¥ -->
        <div class="bullet-input-section" id="bulletSection" style="display: none;">
            <div class="input-group">
                <input type="text" id="bulletInput" placeholder="è¾“å…¥å¼¹å¹•å†…å®¹..." maxlength="50">
                <button class="btn btn-primary" id="sendBtn">å‘é€</button>
            </div>
            <div id="userDisplay" style="display: none; margin-top: 10px; padding: 10px; background: #f8f8f8; border-radius: 10px; display: flex; align-items: center; gap: 10px;">
                <img id="userDisplayAvatar" src="" alt="å¤´åƒ" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid #ccc; display: none;">
                <div style="display: flex; flex-direction: column; gap: 4px; font-size: 14px;">
                    <span id="userDisplayName" style="font-weight: bold; color: #333;"></span>
                    <span id="clientIdDisplay" style="color: #666; font-size: 12px;"></span>
                </div>
            </div>
            <div class="connection-info">
                <strong>æœåŠ¡å™¨åœ°å€ï¼š</strong>
                <input type="text" id="serverUrl" style="width: 100%; margin-top: 5px; padding: 8px;" placeholder="wss://your-server.railway.app">
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn" id="connectBtn" style="flex: 1;">è¿æ¥æœåŠ¡å™¨</button>
                    <button class="btn" id="reconnectBtn" style="flex: 1; background: #28a745; color: white;">é‡æ–°è¿æ¥</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let isConnected = false;
        const STORAGE_KEY = 'player_profile_v1';
        // ä»ä¸»æ¸¸æˆç«¯åŒæ­¥è¿‡æ¥çš„å¼¹å¹•æœ€çŸ­å‘é€é—´éš”ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤ä¸ä¸»æ¸¸æˆé…ç½®ä¸€è‡´ï¼š3ç§’
        let bulletMinIntervalFromServer = 3000;
        // playerId ç”¨äºå”¯ä¸€æ ‡è¯†ç»ˆç«¯ï¼Œé¿å…é‡åè¯¯åˆ¤
        function generatePlayerId() {
            if (crypto.randomUUID) return crypto.randomUUID();
            return 'player_' + Date.now() + '_' + Math.random().toString(16).slice(2);
        }
        let playerInfo = {
            name: '',
            avatarUrl: '',
            playerId: ''
        };

        // DOMå…ƒç´ 
        const elements = {
            playerSetup: document.getElementById('playerSetup'),
            avatarPreview: document.getElementById('avatarPreview'),
            avatarImg: document.getElementById('avatarImg'),
            avatarInput: document.getElementById('avatarInput'),
            uploadBtn: document.getElementById('uploadBtn'),
            playerName: document.getElementById('playerName'),
            confirmSetup: document.getElementById('confirmSetup'),
            status: document.getElementById('status'),
            bulletSection: document.getElementById('bulletSection'),
            bulletInput: document.getElementById('bulletInput'),
            sendBtn: document.getElementById('sendBtn'),
            serverUrl: document.getElementById('serverUrl'),
            connectBtn: document.getElementById('connectBtn'),
            reconnectBtn: document.getElementById('reconnectBtn'),
            userDisplay: document.getElementById('userDisplay'),
            userDisplayName: document.getElementById('userDisplayName'),
            userDisplayAvatar: document.getElementById('userDisplayAvatar'),
            clientIdDisplay: document.getElementById('clientIdDisplay')
        };

        // ä»URLå‚æ•°è¯»å–WebSocketæœåŠ¡å™¨åœ°å€
        function getWebSocketUrlFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const wsParam = urlParams.get('ws');
            console.log('URLå‚æ•° ws:', wsParam);
            console.log('å®Œæ•´URL:', window.location.href);
            console.log('æŸ¥è¯¢å­—ç¬¦ä¸²:', window.location.search);
            
            if (wsParam) {
                // ç¡®ä¿URLæ ¼å¼æ­£ç¡®
                let url = decodeURIComponent(wsParam).trim();
                console.log('è§£æåçš„URL:', url);
                
                // ç§»é™¤å¯èƒ½çš„æ–œæ ç»“å°¾
                url = url.replace(/\/+$/, '');
                
                // å¦‚æœURLåŒ…å«åè®®ï¼Œç›´æ¥è¿”å›
                if (url.startsWith('ws://') || url.startsWith('wss://')) {
                    console.log('è¿”å›WebSocketåœ°å€:', url);
                    return url;
                }
                
                // å¦‚æœæ˜¯å®Œæ•´URLï¼ˆåŒ…å«http://ï¼‰ï¼Œéœ€è¦è½¬æ¢ä¸ºWebSocketåè®®
                if (url.startsWith('http://')) {
                    url = url.replace('http://', 'ws://');
                } else if (url.startsWith('https://')) {
                    url = url.replace('https://', 'wss://');
                } else {
                    // å¦åˆ™æ·»åŠ wss://å‰ç¼€ï¼ˆç”Ÿäº§ç¯å¢ƒé»˜è®¤ä½¿ç”¨å®‰å…¨è¿æ¥ï¼‰
                    url = 'wss://' + url;
                }
                
                console.log('æœ€ç»ˆWebSocketåœ°å€:', url);
                return url;
            }
            return null;
        }

        // åˆå§‹åŒ–æœåŠ¡å™¨åœ°å€
        function initServerUrl() {
            const urlFromParam = getWebSocketUrlFromUrl();
            if (urlFromParam) {
                elements.serverUrl.value = urlFromParam;
                console.log('ä»URLå‚æ•°è¯»å–æœåŠ¡å™¨åœ°å€:', urlFromParam);
            } else {
                // æ£€æŸ¥æ˜¯å¦ä¸ºç”Ÿäº§ç¯å¢ƒ
                const hostname = window.location.hostname;
                if (hostname.includes('netlify.app') || (hostname !== 'localhost' && hostname !== '127.0.0.1')) {
                    // ç”Ÿäº§ç¯å¢ƒä½†æ²¡æœ‰URLå‚æ•°ï¼Œæç¤ºç”¨æˆ·
                    elements.serverUrl.placeholder = 'è¯·è¾“å…¥WebSocketæœåŠ¡å™¨åœ°å€ï¼ˆå¦‚ï¼šwss://your-server.railway.appï¼‰';
                } else {
                    // å¼€å‘ç¯å¢ƒé»˜è®¤å€¼
                    elements.serverUrl.value = 'ws://localhost:8080';
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        initServerUrl();
        loadProfile(); // å°è¯•åŠ è½½æœ¬åœ°ç©å®¶ä¿¡æ¯

        // å¤´åƒä¸Šä¼ 
        elements.uploadBtn.addEventListener('click', () => {
            elements.avatarInput.click();
        });

        elements.avatarInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    playerInfo.avatarUrl = event.target.result;
                    elements.avatarImg.src = event.target.result;
                    elements.avatarImg.style.display = 'block';
                    document.querySelector('.avatar-placeholder').style.display = 'none';
                    checkSetupComplete();
                };
                reader.readAsDataURL(file);
            }
        });

        elements.playerName.addEventListener('input', () => {
            checkSetupComplete();
        });

        function checkSetupComplete() {
            const hasAvatar = playerInfo.avatarUrl !== '';
            const hasName = elements.playerName.value.trim() !== '';
            elements.confirmSetup.disabled = !(hasAvatar && hasName);
        }

        // æœ¬åœ°å­˜å‚¨
        function saveProfile() {
            const data = {
                name: playerInfo.name,
                avatarUrl: playerInfo.avatarUrl,
                playerId: playerInfo.playerId || generatePlayerId()
            };
            playerInfo.playerId = data.playerId;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadProfile() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;
            try {
                const data = JSON.parse(saved);
                playerInfo.name = data.name || '';
                playerInfo.avatarUrl = data.avatarUrl || '';
                playerInfo.playerId = data.playerId || generatePlayerId();

                if (playerInfo.avatarUrl) {
                    elements.avatarImg.src = playerInfo.avatarUrl;
                    elements.avatarImg.style.display = 'block';
                    document.querySelector('.avatar-placeholder').style.display = 'none';
                }
                if (playerInfo.name) {
                    elements.playerName.value = playerInfo.name;
                }
                checkSetupComplete();
                updateUserDisplay();
            } catch (e) {
                console.warn('è¯»å–æœ¬åœ°ç©å®¶ä¿¡æ¯å¤±è´¥', e);
            }
        }

        function updateUserDisplay() {
            if (!elements.userDisplay || !elements.userDisplayName || !elements.userDisplayAvatar) return;
            const hasName = playerInfo.name && playerInfo.name.trim() !== '';
            const hasAvatar = playerInfo.avatarUrl && playerInfo.avatarUrl.trim() !== '';
            if (hasName) {
                elements.userDisplayName.textContent = `ç©å®¶ï¼š${playerInfo.name}`;
            } else {
                elements.userDisplayName.textContent = '';
            }
            if (hasAvatar) {
                elements.userDisplayAvatar.src = playerInfo.avatarUrl;
                elements.userDisplayAvatar.style.display = 'block';
            } else {
                elements.userDisplayAvatar.style.display = 'none';
            }
            if (!playerInfo.playerId) {
                playerInfo.playerId = generatePlayerId();
            }
            if (elements.clientIdDisplay) {
                elements.clientIdDisplay.textContent = `å”¯ä¸€ç ï¼š${playerInfo.playerId}`;
            }
            if (hasName || hasAvatar) {
                elements.userDisplay.style.display = 'flex';
            } else {
                elements.userDisplay.style.display = 'none';
            }
        }

        // ç¡®è®¤è®¾ç½®
        elements.confirmSetup.addEventListener('click', () => {
            const trimmedName = elements.playerName.value.trim();
            if (!trimmedName) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åï¼');
                return;
            }
            playerInfo.name = trimmedName;
            if (!playerInfo.playerId) {
                playerInfo.playerId = generatePlayerId();
            }
            saveProfile();
            updateUserDisplay();
            
            // éšè—è®¾ç½®ç•Œé¢ï¼Œæ˜¾ç¤ºå¼¹å¹•è¾“å…¥ç•Œé¢ï¼ˆä½†ä¸è‡ªåŠ¨è¿æ¥ï¼‰
            // ç­‰å¾…æœåŠ¡å™¨ç¡®è®¤ç”¨æˆ·ååå†æ˜¾ç¤ºå¼¹å¹•è¾“å…¥
            elements.playerSetup.style.display = 'none';
            elements.bulletSection.style.display = 'block';
            
            // è‡ªåŠ¨è¿æ¥æœåŠ¡å™¨ï¼ˆæœåŠ¡å™¨ä¼šéªŒè¯ç”¨æˆ·åï¼‰
            connectToServer();
        });

         // è¿æ¥æœåŠ¡å™¨
         elements.connectBtn.addEventListener('click', () => {
             if (isConnected) {
                 disconnectFromServer();
             } else {
                 // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆè®¾ç½®
                 if (!playerInfo.name || playerInfo.name.trim() === '') {
                     alert('è¯·å…ˆå®Œæˆç©å®¶è®¾ç½®ï¼ˆè¾“å…¥ç”¨æˆ·åå’Œä¸Šä¼ å¤´åƒï¼‰ï¼');
                     // æ˜¾ç¤ºè®¾ç½®ç•Œé¢
                     elements.playerSetup.style.display = 'block';
                     elements.bulletSection.style.display = 'none';
                     return;
                 }
                 connectToServer();
             }
         });

        function connectToServer() {
            // ä¼˜å…ˆä»URLå‚æ•°è¯»å–
            let serverUrl = getWebSocketUrlFromUrl();
            
            // å¦‚æœURLå‚æ•°æ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨è¾“å…¥æ¡†çš„å€¼
            if (!serverUrl) {
                serverUrl = elements.serverUrl.value.trim();
            }
            
            // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œæç¤ºç”¨æˆ·
            if (!serverUrl) {
                alert('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€ï¼\n\næ ¼å¼ï¼šwss://horseyear_game.up.railway.app\n\næˆ–é€šè¿‡URLå‚æ•°ä¼ é€’ï¼š?ws=wss://horseyear_game.up.railway.app');
                return;
            }

            // ç¡®ä¿URLæ ¼å¼æ­£ç¡®
            serverUrl = serverUrl.trim();
            // ç§»é™¤å¯èƒ½çš„æ–œæ ç»“å°¾
            serverUrl = serverUrl.replace(/\/+$/, '');
            
            // éªŒè¯URLæ ¼å¼
            if (!serverUrl.startsWith('ws://') && !serverUrl.startsWith('wss://')) {
                alert('æœåŠ¡å™¨åœ°å€æ ¼å¼é”™è¯¯ï¼\n\nå¿…é¡»ä»¥ ws:// æˆ– wss:// å¼€å¤´\n\nä¾‹å¦‚ï¼šwss://horseyear_game.up.railway.app\n\nå½“å‰å€¼ï¼š' + serverUrl);
                return;
            }

            // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤º
            elements.serverUrl.value = serverUrl;
            
            console.log('æ­£åœ¨è¿æ¥åˆ°WebSocketæœåŠ¡å™¨:', serverUrl);
            elements.status.textContent = 'ğŸ”„ æ­£åœ¨è¿æ¥æœåŠ¡å™¨â€¦';
            elements.connectBtn.textContent = 'è¿æ¥ä¸­â€¦';
            elements.connectBtn.disabled = true;
            if (elements.reconnectBtn) {
                elements.reconnectBtn.disabled = true;
                elements.reconnectBtn.textContent = 'é‡è¿ä¸­â€¦';
            }
            console.log('è¿æ¥åè®®:', serverUrl.startsWith('wss://') ? 'WSS (å®‰å…¨)' : 'WS (éå®‰å…¨)');
            console.log('é¡µé¢åè®®:', window.location.protocol);

            try {
                // å°è¯•å¤šä¸ªè·¯å¾„ï¼ˆRailwayå¯èƒ½éœ€è¦ç‰¹å®šè·¯å¾„ï¼‰
                const urlsToTry = [
                    serverUrl,
                    serverUrl.replace(/\/$/, '') + '/ws',
                    serverUrl.replace(/\/$/, '') + '/websocket'
                ];
                
                let urlIndex = 0;
                let currentUrl = urlsToTry[0];
                
                function tryConnect(url) {
                    console.log(`å°è¯•è¿æ¥ (${urlIndex + 1}/${urlsToTry.length}):`, url);
                    ws = new WebSocket(url);
                    
                    ws.onopen = () => {
                        console.log(`âœ… è¿æ¥æˆåŠŸ! ä½¿ç”¨URL: ${url}`);
                        elements.status.textContent = 'âœ… å·²è¿æ¥ï¼Œç­‰å¾…ç”¨æˆ·åéªŒè¯â€¦';
                        elements.connectBtn.textContent = 'æ–­å¼€è¿æ¥';
                        elements.connectBtn.disabled = false;
                        if (elements.reconnectBtn) {
                            elements.reconnectBtn.disabled = false;
                            elements.reconnectBtn.textContent = 'é‡æ–°è¿æ¥';
                        }
                        
                        // å»¶è¿Ÿå‘é€ç©å®¶ä¿¡æ¯ï¼Œç¡®ä¿è¿æ¥å·²å®Œå…¨å»ºç«‹
                        setTimeout(() => {
                            if (ws && ws.readyState === WebSocket.OPEN) {
                                // å‘é€ç©å®¶ä¿¡æ¯ï¼ˆæœåŠ¡å™¨ä¼šéªŒè¯ç”¨æˆ·åæ˜¯å¦é‡å¤ï¼‰
                                if (!playerInfo.playerId) playerInfo.playerId = generatePlayerId();
                                ws.send(JSON.stringify({
                                    type: 'playerInfo',
                                    playerName: playerInfo.name,
                                    avatarUrl: playerInfo.avatarUrl,
                                    playerId: playerInfo.playerId
                                }));
                                console.log('ğŸ“¤ å·²å‘é€ç©å®¶ä¿¡æ¯ï¼Œç­‰å¾…æœåŠ¡å™¨éªŒè¯...');
                            }
                        }, 100);
                    };
                    
                     ws.onmessage = (event) => {
                         try {
                             const data = JSON.parse(event.data);
                             console.log('æ”¶åˆ°æ¶ˆæ¯:', data);
                             
                             // ä¸»æ¸¸æˆç«¯åŒæ­¥é…ç½®ï¼ˆç›®å‰ä¸»è¦æ˜¯å¼¹å¹•æœ€çŸ­å‘é€é—´éš”ï¼‰
                             if (data.type === 'configUpdate') {
                                 if (typeof data.bulletMinInterval === 'number' && data.bulletMinInterval > 0) {
                                     bulletMinIntervalFromServer = data.bulletMinInterval;
                                     console.log('ğŸ” å·²ä»ä¸»æ¸¸æˆç«¯åŒæ­¥æœ€çŸ­å‘é€é—´éš”:', bulletMinIntervalFromServer, 'ms');
                                 }
                                 return;
                             }
                             
                             // å¤„ç†ç”¨æˆ·åé”™è¯¯ï¼ˆé‡å¤æˆ–ä¸ºç©ºï¼‰
                             if (data.type === 'usernameError') {
                                 console.error('âŒ ç”¨æˆ·åé”™è¯¯:', data.message);
                                 
                                 // æ–­å¼€è¿æ¥
                                 if (ws) {
                                     ws.close();
                                     ws = null;
                                 }
                                 isConnected = false;
                                 updateStatus(false);
                                 elements.connectBtn.textContent = 'è¿æ¥æœåŠ¡å™¨';
                                elements.connectBtn.disabled = false;
                                if (elements.reconnectBtn) {
                                    elements.reconnectBtn.disabled = false;
                                    elements.reconnectBtn.textContent = 'é‡æ–°è¿æ¥';
                                }
                                 
                                 // æ˜¾ç¤ºé”™è¯¯æç¤º
                                 alert(data.message || 'ç”¨æˆ·åæ— æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥ï¼');
                                 
                                 // æ¢å¤åˆ°è®¾ç½®ç•Œé¢ï¼Œè®©ç©å®¶é‡æ–°è¾“å…¥ç”¨æˆ·å
                                 elements.playerSetup.style.display = 'block';
                                 elements.bulletSection.style.display = 'none';
                                 
                                 // æ¸…ç©ºå¹¶èšç„¦ç”¨æˆ·åè¾“å…¥æ¡†
                                 elements.playerName.value = '';
                                 elements.playerName.focus();
                                 
                                 // é‡ç½®ç©å®¶ä¿¡æ¯
                                 playerInfo.name = '';
                                 elements.confirmSetup.disabled = true;
                                 
                                 return;
                             }
                             
                             // å¤„ç†ç”¨æˆ·åç¡®è®¤æˆåŠŸ
                             if (data.type === 'usernameConfirmed') {
                                 console.log('âœ… ç”¨æˆ·åç¡®è®¤æˆåŠŸ:', data.message);
                                if (data.playerId) {
                                    playerInfo.playerId = data.playerId;
                                    saveProfile();
                                    updateUserDisplay();
                                }
                                 isConnected = true;
                                 updateStatus(true);
                                 elements.connectBtn.textContent = 'æ–­å¼€è¿æ¥';
                                if (elements.reconnectBtn) {
                                    elements.reconnectBtn.disabled = false;
                                    elements.reconnectBtn.textContent = 'é‡æ–°è¿æ¥';
                                }
                                 
                                 // ç¡®ä¿å¼¹å¹•è¾“å…¥ç•Œé¢å·²æ˜¾ç¤º
                                 elements.playerSetup.style.display = 'none';
                                 elements.bulletSection.style.display = 'block';
                                 
                                 // èšç„¦å¼¹å¹•è¾“å…¥æ¡†
                                 setTimeout(() => {
                                     elements.bulletInput.focus();
                                 }, 100);
                                 
                                 return;
                             }
                             
                             // å¤„ç†è¿æ¥æˆåŠŸæ¶ˆæ¯ï¼ˆæ—§æ ¼å¼å…¼å®¹ï¼‰
                             if (data.type === 'connected') {
                                 console.log('âœ… æœåŠ¡å™¨è¿æ¥ç¡®è®¤:', data.message);
                                 // æ­¤æ—¶ç”¨æˆ·åè¿˜æœªéªŒè¯ï¼Œç­‰å¾… usernameConfirmed æ¶ˆæ¯
                             }
                         } catch (error) {
                             console.error('æ¶ˆæ¯è§£æé”™è¯¯:', error);
                         }
                     };
                    
                    ws.onerror = (error) => {
                        console.error(`âŒ WebSocketé”™è¯¯ (å°è¯• ${urlIndex + 1}):`, error);
                        console.error('é”™è¯¯è¯¦æƒ…:', {
                            type: error.type,
                            target: error.target,
                            readyState: ws.readyState,
                            url: url
                        });
                        
                        elements.status.textContent = 'âš ï¸ è¿æ¥å¼‚å¸¸ï¼Œæ­£åœ¨å°è¯•å…¶ä»–åœ°å€â€¦';
                        elements.connectBtn.textContent = 'è¿æ¥æœåŠ¡å™¨';
                        elements.connectBtn.disabled = false;
                        if (elements.reconnectBtn) {
                            elements.reconnectBtn.disabled = false;
                            elements.reconnectBtn.textContent = 'é‡æ–°è¿æ¥';
                        }
                        
                        // å¦‚æœè¿˜æœ‰å…¶ä»–URLå¯ä»¥å°è¯•
                        if (urlIndex < urlsToTry.length - 1) {
                            urlIndex++;
                            console.log(`å°è¯•ä¸‹ä¸€ä¸ªURL...`);
                            setTimeout(() => {
                                tryConnect(urlsToTry[urlIndex]);
                            }, 1000);
                        } else {
                            // æ‰€æœ‰URLéƒ½å¤±è´¥äº†
                            let errorMsg = 'è¿æ¥å¤±è´¥ï¼šæ‰€æœ‰å°è¯•çš„URLéƒ½å¤±è´¥äº†';
                            console.error('å¯èƒ½çš„åŸå› ï¼š');
                            console.error('1. RailwayæœåŠ¡å™¨æœªè¿è¡Œæˆ–å·²åœæ­¢');
                            console.error('2. æœåŠ¡å™¨åœ°å€ä¸æ­£ç¡®');
                            console.error('3. Railwayç½‘ç»œé…ç½®é—®é¢˜');
                            console.error('4. WebSocketåè®®ä¸è¢«æ”¯æŒ');
                            console.error('5. Railwayå¯èƒ½éœ€è¦ç‰¹å®šçš„WebSocketè·¯å¾„é…ç½®');
                            
                            updateStatus(false);
                            alert(`è¿æ¥å¤±è´¥ï¼š${errorMsg}\n\nå·²å°è¯•çš„URLï¼š\n${urlsToTry.join('\n')}\n\nè¯·æ£€æŸ¥ï¼š\n1. RailwayæœåŠ¡æ˜¯å¦è¿è¡Œ\n2. Railwayæ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯\n3. è€ƒè™‘åˆ‡æ¢åˆ°RenderæœåŠ¡`);
                        }
                    };
                    
                    ws.onclose = (event) => {
                        console.log(`è¿æ¥å…³é—­ - Code: ${event.code}, Reason: ${event.reason || 'æ— '}, WasClean: ${event.wasClean}`);
                        if (ws.readyState === WebSocket.CLOSED && urlIndex >= urlsToTry.length - 1) {
                            isConnected = false;
                            updateStatus(false);
                            elements.connectBtn.textContent = 'è¿æ¥æœåŠ¡å™¨';
                            elements.connectBtn.disabled = false;
                            if (elements.reconnectBtn) {
                                elements.reconnectBtn.disabled = false;
                                elements.reconnectBtn.textContent = 'é‡æ–°è¿æ¥';
                            }
                            ws = null;
                        }
                    };
                }
                
                tryConnect(currentUrl);
            } catch (error) {
                alert('è¿æ¥å¤±è´¥ï¼š' + error.message);
                updateStatus(false);
            }
        }

        function disconnectFromServer() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function updateStatus(connected) {
            if (connected) {
                elements.status.className = 'status connected';
                elements.status.textContent = 'âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨';
            } else {
                elements.status.className = 'status disconnected';
                elements.status.textContent = 'âš ï¸ æœªè¿æ¥æœåŠ¡å™¨';
            }
        }

        // å‘é€å¼¹å¹•
        elements.sendBtn.addEventListener('click', sendBullet);
        elements.bulletInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBullet();
            }
        });

        // è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦ï¼ˆå…¼å®¹è¡¨æƒ…ç¬¦å·ï¼‰
        function getCharLength(str) {
            return Array.from(str).length;
        }

        let lastBulletSendTime = 0; // ä¸Šæ¬¡å‘é€å¼¹å¹•çš„æ—¶é—´

        function sendBullet() {
            const text = elements.bulletInput.value.trim();
            if (!text) {
                alert('è¯·è¾“å…¥å¼¹å¹•å†…å®¹ï¼');
                return;
            }
            if (!playerInfo.playerId) {
                playerInfo.playerId = generatePlayerId();
                saveProfile();
                updateUserDisplay();
            }
            
            // æ£€æŸ¥å¼¹å¹•å‘é€é—´éš”ï¼šä¼˜å…ˆä½¿ç”¨ä¸»æ¸¸æˆç«¯åŒæ­¥è¿‡æ¥çš„è®¾ç½®ï¼Œé»˜è®¤3ç§’
            const minInterval = bulletMinIntervalFromServer || 3000;
            const currentTime = Date.now();
            const timeSinceLastSend = currentTime - lastBulletSendTime;
            
            if (timeSinceLastSend < minInterval) {
                const remainingTime = Math.ceil((minInterval - timeSinceLastSend) / 1000);
                alert(`å¼¹å¹•å‘é€è¿‡å¿«ï¼è¯·ç­‰å¾… ${remainingTime} ç§’åå†å‘é€ã€‚`);
                return;
            }
            
            // æ£€æŸ¥å¼¹å¹•æœ€å°é•¿åº¦ï¼ˆé»˜è®¤4ä¸ªå­—ç¬¦ï¼Œä¸ä¸»æ¸¸æˆç«¯ä¿æŒä¸€è‡´ï¼‰
            const minLength = 4; // ç©å®¶ç«¯ä½¿ç”¨å›ºå®šå€¼ï¼Œä¸»æ¸¸æˆç«¯å¯åœ¨è®¾ç½®ä¸­é…ç½®
            const charLen = getCharLength(text);
            
            if (charLen < minLength) {
                alert(`å¼¹å¹•å†…å®¹è‡³å°‘éœ€è¦ ${minLength} ä¸ªå­—ç¬¦ï¼Œå½“å‰åªæœ‰ ${charLen} ä¸ªå­—ç¬¦ï¼`);
                return;
            }

            // æ£€æŸ¥å¼¹å¹•æœ€å¤§é•¿åº¦ï¼ˆé»˜è®¤15ä¸ªå­—ï¼‰
            const maxLength = 15;
            if (charLen > maxLength) {
                alert(`å¼¹å¹•å†…å®¹ä¸èƒ½è¶…è¿‡ ${maxLength} ä¸ªå­—ç¬¦ï¼Œå½“å‰ ${charLen} ä¸ªå­—ç¬¦ï¼`);
                return;
            }

            if (!isConnected || !ws || ws.readyState !== WebSocket.OPEN) {
                alert('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨ï¼');
                return;
            }
            
            // æ›´æ–°ä¸Šæ¬¡å‘é€æ—¶é—´
            lastBulletSendTime = currentTime;

            // ç”Ÿæˆå¼¹å¹•ID
            const bulletId = Date.now() + Math.random();
            
            // å‘é€å¼¹å¹•åˆ°æœåŠ¡å™¨
            ws.send(JSON.stringify({
                type: 'bullet',
                player: {
                    name: playerInfo.name,
                    avatarUrl: playerInfo.avatarUrl,
                    playerId: playerInfo.playerId
                },
                text: text,
                id: bulletId  // æ·»åŠ IDç”¨äºå»é‡
            }));

            // æ¸…ç©ºè¾“å…¥æ¡†
            elements.bulletInput.value = '';
            
            // è‡ªåŠ¨èšç„¦
            setTimeout(() => {
                elements.bulletInput.focus();
            }, 100);
        }

        // é¡µé¢å¸è½½æ—¶æ–­å¼€è¿æ¥
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>
