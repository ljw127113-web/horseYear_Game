<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>å¼¹å¹•BOSSæˆ˜ - ç©å®¶ç«¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            -webkit-user-select: none;
            user-select: none;
        }

        .player-container {
            width: 100%;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .player-setup {
            margin-bottom: 30px;
        }

        .setup-item {
            margin-bottom: 20px;
        }

        .setup-item label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        .avatar-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .avatar-preview {
            width: 100px;
            height: 100px;
            border: 3px dashed #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #f5f5f5;
            cursor: pointer;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .avatar-placeholder {
            color: #999;
            font-size: 14px;
        }

        input[type="file"] {
            display: none;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .bullet-input-section {
            margin-top: 30px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .input-group input {
            flex: 1;
            font-size: 16px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            min-height: 44px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .connection-info {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 10px;
            font-size: 14px;
            color: #666;
        }

        @media (max-width: 768px) {
            .player-container {
                padding: 20px;
            }

            h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="player-container">
        <h1>ğŸ® å¼¹å¹•BOSSæˆ˜ - ç©å®¶ç«¯</h1>
        
        <!-- ç©å®¶è®¾ç½® -->
        <div class="player-setup" id="playerSetup">
            <div class="setup-item">
                <label>ä¸Šä¼ å¤´åƒï¼š</label>
                <div class="avatar-section">
                    <div class="avatar-preview" id="avatarPreview">
                        <img id="avatarImg" src="" alt="å¤´åƒ">
                        <div class="avatar-placeholder">ç‚¹å‡»ä¸Šä¼ </div>
                    </div>
                    <input type="file" id="avatarInput" accept="image/*">
                    <button class="btn" id="uploadBtn">é€‰æ‹©å¤´åƒ</button>
                </div>
            </div>
            <div class="setup-item">
                <label>ç©å®¶åå­—ï¼š</label>
                <input type="text" id="playerName" placeholder="è¯·è¾“å…¥ä½ çš„åå­—" maxlength="20">
            </div>
            <button class="btn btn-primary" id="confirmSetup" disabled>ç¡®è®¤è®¾ç½®</button>
        </div>

        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="status disconnected" id="status">
            âš ï¸ æœªè¿æ¥æœåŠ¡å™¨
        </div>

        <!-- å¼¹å¹•è¾“å…¥ -->
        <div class="bullet-input-section" id="bulletSection" style="display: none;">
            <div class="input-group">
                <input type="text" id="bulletInput" placeholder="è¾“å…¥å¼¹å¹•å†…å®¹..." maxlength="50">
                <button class="btn btn-primary" id="sendBtn">å‘é€</button>
            </div>
            <div class="connection-info">
                <strong>æœåŠ¡å™¨åœ°å€ï¼š</strong>
                <input type="text" id="serverUrl" style="width: 100%; margin-top: 5px; padding: 8px;" placeholder="wss://your-server.railway.app">
                <button class="btn" id="connectBtn" style="width: 100%; margin-top: 10px;">è¿æ¥æœåŠ¡å™¨</button>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let playerInfo = {
            name: '',
            avatarUrl: ''
        };
        let isConnected = false;

        // DOMå…ƒç´ 
        const elements = {
            playerSetup: document.getElementById('playerSetup'),
            avatarPreview: document.getElementById('avatarPreview'),
            avatarImg: document.getElementById('avatarImg'),
            avatarInput: document.getElementById('avatarInput'),
            uploadBtn: document.getElementById('uploadBtn'),
            playerName: document.getElementById('playerName'),
            confirmSetup: document.getElementById('confirmSetup'),
            status: document.getElementById('status'),
            bulletSection: document.getElementById('bulletSection'),
            bulletInput: document.getElementById('bulletInput'),
            sendBtn: document.getElementById('sendBtn'),
            serverUrl: document.getElementById('serverUrl'),
            connectBtn: document.getElementById('connectBtn')
        };

        // ä»URLå‚æ•°è¯»å–WebSocketæœåŠ¡å™¨åœ°å€
        function getWebSocketUrlFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const wsParam = urlParams.get('ws');
            console.log('URLå‚æ•° ws:', wsParam);
            console.log('å®Œæ•´URL:', window.location.href);
            console.log('æŸ¥è¯¢å­—ç¬¦ä¸²:', window.location.search);
            
            if (wsParam) {
                // ç¡®ä¿URLæ ¼å¼æ­£ç¡®
                let url = decodeURIComponent(wsParam).trim();
                console.log('è§£æåçš„URL:', url);
                
                // ç§»é™¤å¯èƒ½çš„æ–œæ ç»“å°¾
                url = url.replace(/\/+$/, '');
                
                // å¦‚æœURLåŒ…å«åè®®ï¼Œç›´æ¥è¿”å›
                if (url.startsWith('ws://') || url.startsWith('wss://')) {
                    console.log('è¿”å›WebSocketåœ°å€:', url);
                    return url;
                }
                
                // å¦‚æœæ˜¯å®Œæ•´URLï¼ˆåŒ…å«http://ï¼‰ï¼Œéœ€è¦è½¬æ¢ä¸ºWebSocketåè®®
                if (url.startsWith('http://')) {
                    url = url.replace('http://', 'ws://');
                } else if (url.startsWith('https://')) {
                    url = url.replace('https://', 'wss://');
                } else {
                    // å¦åˆ™æ·»åŠ wss://å‰ç¼€ï¼ˆç”Ÿäº§ç¯å¢ƒé»˜è®¤ä½¿ç”¨å®‰å…¨è¿æ¥ï¼‰
                    url = 'wss://' + url;
                }
                
                console.log('æœ€ç»ˆWebSocketåœ°å€:', url);
                return url;
            }
            return null;
        }

        // åˆå§‹åŒ–æœåŠ¡å™¨åœ°å€
        function initServerUrl() {
            const urlFromParam = getWebSocketUrlFromUrl();
            if (urlFromParam) {
                elements.serverUrl.value = urlFromParam;
                console.log('ä»URLå‚æ•°è¯»å–æœåŠ¡å™¨åœ°å€:', urlFromParam);
            } else {
                // æ£€æŸ¥æ˜¯å¦ä¸ºç”Ÿäº§ç¯å¢ƒ
                const hostname = window.location.hostname;
                if (hostname.includes('netlify.app') || (hostname !== 'localhost' && hostname !== '127.0.0.1')) {
                    // ç”Ÿäº§ç¯å¢ƒä½†æ²¡æœ‰URLå‚æ•°ï¼Œæç¤ºç”¨æˆ·
                    elements.serverUrl.placeholder = 'è¯·è¾“å…¥WebSocketæœåŠ¡å™¨åœ°å€ï¼ˆå¦‚ï¼šwss://your-server.railway.appï¼‰';
                } else {
                    // å¼€å‘ç¯å¢ƒé»˜è®¤å€¼
                    elements.serverUrl.value = 'ws://localhost:8080';
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        initServerUrl();

        // å¤´åƒä¸Šä¼ 
        elements.uploadBtn.addEventListener('click', () => {
            elements.avatarInput.click();
        });

        elements.avatarInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    playerInfo.avatarUrl = event.target.result;
                    elements.avatarImg.src = event.target.result;
                    elements.avatarImg.style.display = 'block';
                    document.querySelector('.avatar-placeholder').style.display = 'none';
                    checkSetupComplete();
                };
                reader.readAsDataURL(file);
            }
        });

        elements.playerName.addEventListener('input', () => {
            checkSetupComplete();
        });

        function checkSetupComplete() {
            const hasAvatar = playerInfo.avatarUrl !== '';
            const hasName = elements.playerName.value.trim() !== '';
            elements.confirmSetup.disabled = !(hasAvatar && hasName);
        }

        // ç¡®è®¤è®¾ç½®
        elements.confirmSetup.addEventListener('click', () => {
            playerInfo.name = elements.playerName.value.trim();
            elements.playerSetup.style.display = 'none';
            elements.bulletSection.style.display = 'block';
            
            // è‡ªåŠ¨è¿æ¥æœåŠ¡å™¨
            connectToServer();
        });

        // è¿æ¥æœåŠ¡å™¨
        elements.connectBtn.addEventListener('click', () => {
            if (isConnected) {
                disconnectFromServer();
            } else {
                connectToServer();
            }
        });

        function connectToServer() {
            // ä¼˜å…ˆä»URLå‚æ•°è¯»å–
            let serverUrl = getWebSocketUrlFromUrl();
            
            // å¦‚æœURLå‚æ•°æ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨è¾“å…¥æ¡†çš„å€¼
            if (!serverUrl) {
                serverUrl = elements.serverUrl.value.trim();
            }
            
            // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œæç¤ºç”¨æˆ·
            if (!serverUrl) {
                alert('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€ï¼\n\næ ¼å¼ï¼šwss://horseyear_game.up.railway.app\n\næˆ–é€šè¿‡URLå‚æ•°ä¼ é€’ï¼š?ws=wss://horseyear_game.up.railway.app');
                return;
            }

            // ç¡®ä¿URLæ ¼å¼æ­£ç¡®
            serverUrl = serverUrl.trim();
            // ç§»é™¤å¯èƒ½çš„æ–œæ ç»“å°¾
            serverUrl = serverUrl.replace(/\/+$/, '');
            
            // éªŒè¯URLæ ¼å¼
            if (!serverUrl.startsWith('ws://') && !serverUrl.startsWith('wss://')) {
                alert('æœåŠ¡å™¨åœ°å€æ ¼å¼é”™è¯¯ï¼\n\nå¿…é¡»ä»¥ ws:// æˆ– wss:// å¼€å¤´\n\nä¾‹å¦‚ï¼šwss://horseyear_game.up.railway.app\n\nå½“å‰å€¼ï¼š' + serverUrl);
                return;
            }

            // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤º
            elements.serverUrl.value = serverUrl;
            
            console.log('æ­£åœ¨è¿æ¥åˆ°WebSocketæœåŠ¡å™¨:', serverUrl);

            try {
                ws = new WebSocket(serverUrl);

                ws.onopen = () => {
                    console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                    isConnected = true;
                    updateStatus(true);
                    elements.connectBtn.textContent = 'æ–­å¼€è¿æ¥';
                    
                    // å‘é€ç©å®¶ä¿¡æ¯
                    ws.send(JSON.stringify({
                        type: 'playerInfo',
                        playerName: playerInfo.name,
                        avatarUrl: playerInfo.avatarUrl
                    }));
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        // ç©å®¶ç«¯åªéœ€è¦ç¡®è®¤è¿æ¥ï¼Œä¸éœ€è¦å¤„ç†å…¶ä»–æ¶ˆæ¯
                    } catch (error) {
                        console.error('æ¶ˆæ¯è§£æé”™è¯¯:', error);
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocketé”™è¯¯:', error);
                    updateStatus(false);
                };

                ws.onclose = () => {
                    console.log('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
                    isConnected = false;
                    updateStatus(false);
                    elements.connectBtn.textContent = 'è¿æ¥æœåŠ¡å™¨';
                    ws = null;
                };
            } catch (error) {
                alert('è¿æ¥å¤±è´¥ï¼š' + error.message);
                updateStatus(false);
            }
        }

        function disconnectFromServer() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function updateStatus(connected) {
            if (connected) {
                elements.status.className = 'status connected';
                elements.status.textContent = 'âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨';
            } else {
                elements.status.className = 'status disconnected';
                elements.status.textContent = 'âš ï¸ æœªè¿æ¥æœåŠ¡å™¨';
            }
        }

        // å‘é€å¼¹å¹•
        elements.sendBtn.addEventListener('click', sendBullet);
        elements.bulletInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBullet();
            }
        });

        function sendBullet() {
            const text = elements.bulletInput.value.trim();
            if (!text) {
                alert('è¯·è¾“å…¥å¼¹å¹•å†…å®¹ï¼');
                return;
            }

            if (!isConnected || !ws || ws.readyState !== WebSocket.OPEN) {
                alert('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨ï¼');
                return;
            }

            // å‘é€å¼¹å¹•åˆ°æœåŠ¡å™¨
            ws.send(JSON.stringify({
                type: 'bullet',
                player: {
                    name: playerInfo.name,
                    avatarUrl: playerInfo.avatarUrl
                },
                text: text
            }));

            // æ¸…ç©ºè¾“å…¥æ¡†
            elements.bulletInput.value = '';
            
            // è‡ªåŠ¨èšç„¦
            setTimeout(() => {
                elements.bulletInput.focus();
            }, 100);
        }

        // é¡µé¢å¸è½½æ—¶æ–­å¼€è¿æ¥
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>
